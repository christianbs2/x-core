local Scene = {
    PlayerLocation = vector3(-144.8742, -601.9526, 167.0002), -- vector4(-142.8742, -601.9526, 167.0002, 270.3301)

    SelectedAnimation = {
        Dictionary = "friends@frj@ig_1",
        Animation = "wave_a"
    },

    Peds = {
        {
            Ped = {
                Location = vector3(-138.7061, -602.9554, 167.5999), -- vector4(-138.6061, -602.9554, 167.5999, 40.7208)
                Heading = 40.7208,

                Model = GetHashKey("mp_m_freemode_01"),

                Animation = "sitchair2",

                Appearance = json.decode('{"decals_2":0,"eyebrows_2":10,"chain_1":12,"skin":2,"ears_1":-1,"glasses_2":0,"makeup_2":0,"sex":0,"chin_bone_length":0,"arms":4,"eye_color":6,"hair_2":0,"nose_width":0,"pants_2":5,"jaw_bone_back_length":0,"lipstick_4":0,"torso_1":99,"nose_peak_lowering":0,"bproof_2":0,"nose_bone_height":0,"shoes_2":3,"lips_thickness":0,"chin_bone_width":0,"makeup_3":0,"cheek_bone_height":0,"arms_2":0,"pants_1":24,"shoes_1":20,"glasses_1":-1,"tshirt_2":0,"bags_2":0,"cheeks_width":0,"lipstick_2":0,"age_1":0,"beard_3":0,"lipstick_1":0,"face":0,"eyebrow_height":0,"eyebrow_forward":0,"bracelets_2":1,"chin_bone_lowering":0,"helmet_1":12,"watches_1":-1,"hair_color_1":0,"nose_bone_twist":0,"lipstick_3":22,"age_2":0,"nose_peak_length":0,"beard_1":2,"eyebrows_4":0,"eyebrows_1":1,"cheek_bone_width":0,"bproof_1":0,"makeup_4":0,"eyes_opening":0,"hair_1":19,"ears_2":0,"bags_1":0,"beard_2":10,"chain_2":2,"nose_peak_height":0,"helmet_2":1,"mask_1":0,"bracelets_1":-1,"tshirt_1":15,"decals_1":0,"chin_hole":0,"hair_color_2":0,"jaw_bone_width":0,"makeup_1":0,"mask_2":0,"neck_thickness":0,"eyebrows_3":0,"beard_4":0,"watches_2":2,"torso_2":0}')
            },

            Vehicle = {
                Location = vector3(-834.5547, -399.7122, 31.3253 - 0.3),
                Heading = 334.1934,
            
                Model = GetHashKey("gauntlet4")
            }
        },
        {
            Ped = {
                Location = vector3(-138.2823, -600.5807, 167.6137), -- vector4(-138.2823, -600.5807, 167.6137, 134.4257)
                Heading = 134.43,

                Model = GetHashKey("mp_m_freemode_01"),

                Animation = "sitchair2",

                Appearance = json.decode('{"decals_2":0,"eyebrows_2":10,"chain_1":12,"skin":2,"ears_1":-1,"glasses_2":0,"makeup_2":0,"sex":0,"chin_bone_length":0,"arms":4,"eye_color":6,"hair_2":0,"nose_width":0,"pants_2":5,"jaw_bone_back_length":0,"lipstick_4":0,"torso_1":99,"nose_peak_lowering":0,"bproof_2":0,"nose_bone_height":0,"shoes_2":3,"lips_thickness":0,"chin_bone_width":0,"makeup_3":0,"cheek_bone_height":0,"arms_2":0,"pants_1":24,"shoes_1":20,"glasses_1":-1,"tshirt_2":0,"bags_2":0,"cheeks_width":0,"lipstick_2":0,"age_1":0,"beard_3":0,"lipstick_1":0,"face":0,"eyebrow_height":0,"eyebrow_forward":0,"bracelets_2":1,"chin_bone_lowering":0,"helmet_1":12,"watches_1":-1,"hair_color_1":0,"nose_bone_twist":0,"lipstick_3":22,"age_2":0,"nose_peak_length":0,"beard_1":2,"eyebrows_4":0,"eyebrows_1":1,"cheek_bone_width":0,"bproof_1":0,"makeup_4":0,"eyes_opening":0,"hair_1":19,"ears_2":0,"bags_1":0,"beard_2":10,"chain_2":2,"nose_peak_height":0,"helmet_2":1,"mask_1":0,"bracelets_1":-1,"tshirt_1":15,"decals_1":0,"chin_hole":0,"hair_color_2":0,"jaw_bone_width":0,"makeup_1":0,"mask_2":0,"neck_thickness":0,"eyebrows_3":0,"beard_4":0,"watches_2":2,"torso_2":0}')
            },

            Vehicle = {
                Location = vector3(-836.3283, -395.5782, 31.3253),
                Heading = 205.1166,
            
                Model = GetHashKey("double")
            }
        },
        {
            Ped = {
                Location = vector3(-136.8908, -601.8316, 168.0711), -- vector4(-136.8908, -601.8316, 168.0711, 86.64437)
                Heading = 95.7,

                Model = GetHashKey("mp_m_freemode_01"),

                Animation = "sleep",

                Appearance = json.decode('{"jaw_bone_width":0,"mask_1":0,"beard_3":0,"bags_2":0,"eyebrows_4":0,"lipstick_2":0,"ears_1":-1,"sex":1,"beard_4":0,"bracelets_1":7,"shoes_1":20,"torso_1":50,"nose_width":0,"eyebrows_2":10,"hair_color_2":0,"eyebrow_height":0,"skin":2,"bproof_1":0,"eye_color":5,"pants_1":57,"nose_peak_height":0,"age_1":0,"lipstick_1":0,"hair_color_1":16,"helmet_1":-1,"arms_2":0,"beard_1":0,"eyebrows_1":1,"face":31,"ears_2":0,"decals_1":0,"makeup_1":0,"makeup_2":10,"cheeks_width":0,"chain_1":3,"hair_2":0,"shoes_2":3,"lips_thickness":0,"hair_1":24,"lipstick_3":22,"bags_1":0,"chin_hole":0,"decals_2":0,"bracelets_2":1,"eyes_opening":0,"cheek_bone_height":0,"nose_peak_lowering":0,"chin_bone_width":0,"jaw_bone_back_length":0,"chin_bone_lowering":0,"nose_bone_height":0,"makeup_4":0,"chin_bone_length":0,"lipstick_4":0,"nose_bone_twist":0,"helmet_2":1,"eyebrow_forward":0,"age_2":0,"bproof_2":0,"glasses_1":-1,"neck_thickness":0,"tshirt_1":15,"arms":4,"glasses_2":0,"makeup_3":0,"torso_2":1,"cheek_bone_width":0,"tshirt_2":0,"chain_2":0,"pants_2":2,"nose_peak_length":0,"watches_2":2,"eyebrows_3":0,"watches_1":21,"beard_2":0,"mask_2":0}'),
                Tattoos = json.decode('[{"Garment":"All","CollectionHash":598190139,"Type":"TYPE_TATTOO","OverlayName":"FM_Tat_F_006","OverlayHash":1481126084,"ZoneName":"ZONE_LEFT_ARM","Price":-1,"Gender":"GENDER_FEMALE"},{"Garment":"All","CollectionHash":598190139,"Type":"TYPE_TATTOO","OverlayName":"FM_Tat_Award_F_010","OverlayHash":1512524481,"ZoneName":"ZONE_RIGHT_ARM","Price":-1,"Gender":"GENDER_FEMALE"},{"Garment":"All","CollectionHash":598190139,"Type":"TYPE_TATTOO","OverlayName":"FM_Tat_F_008","OverlayHash":3353317361,"ZoneName":"ZONE_LEFT_LEG","Price":-1,"Gender":"GENDER_FEMALE"},{"CollectionHash":4054732749,"Type":"TYPE_TATTOO","OverlayName":"MP_MP_Biker_Tat_048_F","OverlayHash":2146762380,"Garment":"All","ZoneName":"ZONE_RIGHT_LEG","Facing":"TATTOO_FRONT","Price":8930,"TranslatedLabel":{"Polish":"STFU","Italian":"STFU","Russian":"STFU","English":"STFU","German":"STFU","French":"TG","Hash":763146153},"UpdateGroup":"LEG_RIGHT_LOWER_OUTER","Gender":"GENDER_FEMALE"}]')
            },

            Vehicle = {
                Location = vector3(-837.7097, -391.7499, 31.3253),
                Heading = 251.8975,
            
                Model = GetHashKey("mesa3")
            }
        }
    },

    Camera = {
        Location = vector3(-142.4742, -601.9526, 167.5002 + 0.985),
        Rotation = vector3(-15.0, 0.0, 269.83012),

        Fov = 60.0
    }
}

local handles = {}

SetupCharacters = function()
    Heap.Selecting = true

    DoScreenFadeOut(0)
    Citizen.Wait(500)

    SpawnScene()

    DisplayRadar(false)
    TriggerEvent("hud", false)

    Citizen.Wait(1500)
    exports["x-instance"]:EnterInstance(math.random(1000000))

    Citizen.Wait(500)
    
    --print("[DEBUG] Försöker stänga laddningsskärmen...")  -- Debug print
    ShutdownLoadingScreen()
    ShutdownLoadingScreenNui()
    --print("[DEBUG] Laddningsskärmen borde vara borta nu.")

    DoScreenFadeIn(3000)
end


SpawnScene = function()
    Cleanup()

    SetEntityCoords(PlayerPedId(), Scene.PlayerLocation)

    Camera.CameraHandles = {
        CENTER = Camera.CreateCam(Scene.Camera)
    }

    Camera.HandleCam("CENTER", "NONE")

    Camera.ShakeCam("CENTER", "HAND_SHAKE", 0.25)

    for pedIndex, pedData in ipairs(Scene.Peds) do
        local charData = Characters[pedIndex]

        handles[pedIndex] = {}

        Camera.CameraHandles["PED_" .. pedIndex] = Camera.CreateCam({
            Location = Scene.Camera.Location,
            Rotation = Scene.Camera.Rotation,
            Fov = 26.5
        })

        if pedData.Ped then
            local ped = pedData.Ped

            local appearance = ped.Appearance

            if charData then
                if charData.appearance then
                    appearance = json.decode(charData.appearance)

                    if appearance then
                        local pedList = exports["x-appearance"]:GetPedList()

                        ped.Model = GetHashKey(pedList[appearance.sex + 1])
                    end
                end
            end

            LoadModels({
                ped.Model
            })

            local handle = CreatePed(5, ped.Model, ped.Location - vector3(0.0, 0.0, 0.985), ped.Heading)

            PointCamAtEntity(Camera.CameraHandles["PED_" .. pedIndex], handle)

            FreezeEntityPosition(handle, true)

            local tattoos = pedData.Tattoos

            if charData then
                if charData.tattoos then
                    tattoos = json.decode(charData.tattoos)
                end
            else
                SetEntityAlpha(handle, 102)
            end

            if appearance then
                exports["x-appearance"]:ApplySkin(appearance, false, handle)
            end

            if tattoos then
                exports["x-tattooshop"]:DrawTattoo(false, handle, tattoos)
            end

            if ped.Animation then
                local animDict, animName = "amb@world_human_cheering@male_a", "base" -- fallback default

            if ped.Animation == "sitchair2" then
                animDict = "timetable@ron@ig_5_p3"
                animName = "ig_5_p3_base"
            elseif ped.Animation == "sleep" then
                animDict = "timetable@tracy@sleep@"
                animName = "idle_c"
            elseif ped.Animation == "wave_a" then
                animDict = "friends@frj@ig_1"
                animName = "wave_a"
            end

            RequestAnimDict(animDict)
            while not HasAnimDictLoaded(animDict) do
                Citizen.Wait(10)
            end

            TaskPlayAnim(handle, animDict, animName, 8.0, -8.0, -1, 1, 0, false, false, false)
        end



            handles[pedIndex].Ped = handle

            AddContext(handle, pedIndex)

            CleanupModels({
                ped.Model
            })
        end

        if pedData.Vehicle then
            local veh = pedData.Vehicle
            local vehModel = veh.Model

            LoadModels({
                vehModel
            })

            local handle = CreateVehicle(vehModel, veh.Location, veh.Heading)

            ModifyVehicle(handle, 0, 0, 0)

            PlaceObjectOnGroundProperly(handle)

            if not charData then
                SetEntityAlpha(handle, 102)
            end

            handles[pedIndex].Vehicle = handle

            exports["x-context"]:AddCustomMenu(handle, function()
                return
            end)

            CleanupModels({
                vehModel
            })
        end
    end
end

AddContext = function(handle, pedIndex)
    local characterData = Characters[pedIndex]

    local isCreated = characterData ~= nil

    exports["x-context"]:AddCustomMenu(handle, function()
        if not isCreated then return end

        while IsControlPressed(0, 19) do
            Citizen.Wait(0)
        end

        local validation = OpenInput('Skriv "DELETE" i rutan för att radera karaktären.', "REMOVE_CHARACTER_INPUT")

        local deleteCharacter = validation and string.upper(validation) == "DELETE"

        if not deleteCharacter then return end

        TriggerServerEvent("x-character:deleteCharacter", characterData.characterId)

        FetchCharacters()
    end, function()
        -- if characeterData.timeLocked > 0 then X.Notify('Karaktär', "Din karaktär är låst i " .. characeterData.timeLocked .. " timmar till.", 5000, "error") return end
        if isCreated then
            Camera.HandleCam("CENTER", "PED_" .. pedIndex, 1500)

            while IsCamInterpolating(Camera.CameraHandles["PED_" .. pedIndex]) do
                Citizen.Wait(0)
            end

            --PlayAnimation(handle, Scene.SelectedAnimation.Dictionary, Scene.SelectedAnimation.Animation, {
            --    flag = 0
            --})
            --
            --while IsEntityPlayingAnim(handle, Scene.SelectedAnimation.Dictionary, Scene.SelectedAnimation.Animation, 3) do
            --    Citizen.Wait(0)
            --end

            SwitchOutPlayer(handle, 0, 1)

            while GetPlayerSwitchState() ~= 5 do
                Citizen.Wait(0)
            end

            ChooseCharacter(characterData)

            Cleanup(true)
        else
            OpenCharacterCreationNUI()
        end
    end)

    local removeLoop = false

    exports["x-context"]:AddCustomHover(handle, function(isHovering)
        if isHovering then
            removeLoop = false

            local spotLightCoords = GetEntityCoords(handle) + vector3(0.0, 0.0, 3.0)
            local pedCoords = GetEntityCoords(handle)

            Citizen.CreateThread(function()
                while not removeLoop do
                    Citizen.Wait(0)

                    DrawSpotLight(spotLightCoords, pedCoords - spotLightCoords, 255, 255, 255, 100.0, 1.0, 0.0, 13.0, 1.0)
                end
            end)
        else
            removeLoop = true
        end
    end)
end

AddEventHandler("onResourceStop", function(resource)
    if resource == GetCurrentResourceName() then
        Cleanup()

        SetEntityVisible(PlayerPedId(), true)
    end
end)

Cleanup = function(exit)
    for _, p in ipairs(handles) do
        DeleteEntity(p.Vehicle)
        DeleteEntity(p.Ped)
    end

    if exit then
        Camera.Cleanup()

        TriggerEvent("hud", true)

        Heap.Selecting = false
    end
end

DrawPointText = function(pointData)
    if Heap.Scaleform and HasScaleformMovieLoaded(Heap.Scaleform) then
        if not IsPauseMenuActive() then
            PushScaleformMovieFunction(Heap.Scaleform, "SHOW_MIDSIZED_MESSAGE")
            PushScaleformMovieFunctionParameterString("~y~" .. pointData.Label)
            PushScaleformMovieFunctionParameterString(
                    pointData.Text
            )
            PopScaleformMovieFunctionVoid()

            DrawScaleformMovie_3dSolid(
                Heap.Scaleform,
                pointData.Location,
                pointData.Rotation,
                1.0,
                1.0,
                1.0,
                pointData.Scale,
                pointData.Scale * 0.8,
                1.0,
                5
            )
        end
    end
end